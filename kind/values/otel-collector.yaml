mode: deployment

image:
  repository: otel/opentelemetry-collector-contrib

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

clusterRole:
  create: true
  rules:
    - apiGroups: [""]
      resources: ["pods", "namespaces", "nodes"]
      verbs: ["get", "list", "watch"]
    - apiGroups: ["apps"]
      resources: ["replicasets"]
      verbs: ["get", "list", "watch"]

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8889"

config:
  extensions:
    health_check:
      endpoint: 0.0.0.0:13133

  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318

  processors:
    # Memory limiter prevents OOM under load (must be first in pipeline)
    memory_limiter:
      check_interval: 5s
      limit_mib: 400
      spike_limit_mib: 100
    batch:
      send_batch_size: 1024
      send_batch_max_size: 2048
      timeout: 5s
    # Enrich telemetry with Kubernetes metadata (Pod name, Namespace, Nodes, etc.)
    k8sattributes:
      auth_type: "serviceAccount"
      passthrough: false
      extract:
        metadata:
          - k8s.pod.name
          - k8s.pod.uid
          - k8s.deployment.name
          - k8s.namespace.name
          - k8s.node.name
          - k8s.pod.start_time
      # Pod association using IP (since Collector runs as Deployment/DaemonSet)
      pod_association:
        - sources:
            - from: resource_attribute
              name: k8s.pod.ip
        - sources:
            - from: resource_attribute
              name: k8s.pod.uid
        - sources:
            - from: connection

  exporters:
    # 1. TRACES -> TEMPO
    otlp/traces:
      endpoint: tempo:4317
      tls:
        insecure: true

    # 2. METRICS -> PROMETHEUS SCRAPE
    # Expose metrics on a port for Prometheus to scrape
    prometheus:
      endpoint: "0.0.0.0:8889"
      resource_to_telemetry_conversion:
        enabled: true # Converts resource attributes to Prometheus labels

    # 3. LOGS -> LOKI (Via Loki Gateway)
    # Point to the Gateway handling ingestion
    otlphttp/loki:
      endpoint: "http://loki-gateway/otlp"
      tls:
        insecure: true

  service:
    extensions: [health_check]
    pipelines:
      traces:
        receivers: [otlp]
        processors: [memory_limiter, k8sattributes, batch]
        exporters: [otlp/traces]
      metrics:
        receivers: [otlp]
        processors: [memory_limiter, k8sattributes, batch]
        exporters: [prometheus]
      logs:
        receivers: [otlp]
        processors: [memory_limiter, k8sattributes, batch]
        exporters: [otlphttp/loki]

ports:
  prometheus:
    enabled: true
    containerPort: 8889
    servicePort: 8889
    protocol: TCP
